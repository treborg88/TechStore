# Configuraci√≥n de Base de Datos ‚Äî Gu√≠a Completa

> Proceso paso a paso para configurar Supabase desde cero hasta una tienda 100% funcional.
> √öltima actualizaci√≥n: Feb 2026.

---

## √çndice

1. [Requisitos Previos](#1-requisitos-previos)
2. [Crear Proyecto en Supabase](#2-crear-proyecto-en-supabase)
3. [Obtener Credenciales](#3-obtener-credenciales)
4. [Configuraci√≥n Autom√°tica (Setup Wizard)](#4-configuraci√≥n-autom√°tica-setup-wizard)
5. [Configuraci√≥n Manual (alternativa)](#5-configuraci√≥n-manual-alternativa)
6. [Verificar que Todo Funciona](#6-verificar-que-todo-funciona)
7. [Credenciales por Defecto](#7-credenciales-por-defecto)
8. [Estructura de la Base de Datos](#8-estructura-de-la-base-de-datos)
9. [Troubleshooting](#9-troubleshooting)

---

## 1. Requisitos Previos

- **Node.js** 18+ instalado
- **npm** instalado
- Cuenta en [Supabase](https://supabase.com) (gratis)
- Backend `.env` con al menos `JWT_SECRET` definido (el servidor no arranca sin √©l)

```bash
# Dependencias instaladas
cd backend && npm install    # incluye @supabase/supabase-js, pg, bcrypt
cd frontend && npm install
```

---

## 2. Crear Proyecto en Supabase

1. Ve a [supabase.com/dashboard](https://supabase.com/dashboard)
2. Click **New Project**
3. Completa:
   - **Name**: cualquiera (ej. `mi-tienda`)
   - **Database Password**: **gu√°rdala** ‚Äî la necesitar√°s para el Connection String
   - **Region**: la m√°s cercana a tu servidor (ej. `us-west-2`, `us-east-1`)
4. Espera ~2 minutos a que el proyecto se cree

---

## 3. Obtener Credenciales

### 3a. URL y Anon Key (para la API REST)

1. Supabase Dashboard ‚Üí tu proyecto ‚Üí **Settings** (‚öôÔ∏è) ‚Üí **API**
2. Copia:
   - **Project URL**: `https://xxxxxxxxxxxx.supabase.co`
   - **anon public key**: `eyJhbGciOi...` (es el API key p√∫blico)

### 3b. Connection String (para crear las tablas)

1. Supabase Dashboard ‚Üí tu proyecto ‚Üí bot√≥n **Connect** (arriba a la derecha)
2. Tab **Connection String** ‚Üí Type: **URI**
3. **Method: Session pooler** ‚ö†Ô∏è (NO Direct connection, NO Transaction)
4. Copia el URI completo:
   ```
   postgresql://postgres.XXXXXXXXXX:[YOUR-PASSWORD]@aws-0-REGION.pooler.supabase.com:5432/postgres
   ```
5. Reemplaza `[YOUR-PASSWORD]` con la contrase√±a que elegiste al crear el proyecto

> **‚ö†Ô∏è IMPORTANTE:** El Connection String debe ser **Session pooler** (puerto 5432).
> - **Direct connection** (`db.<ref>.supabase.co`) no funciona en redes IPv4
> - **Transaction mode** (puerto 6543) no soporta DDL (`CREATE TABLE`)

---

## 4. Configuraci√≥n Autom√°tica (Setup Wizard)

Este es el m√©todo recomendado. El wizard crea tablas, datos iniciales, bucket de Storage y policies autom√°ticamente.

### 4.1 Arrancar el Backend en Modo Setup

Aseg√∫rate de que `SUPABASE_URL` y `SUPABASE_KEY` est√©n **comentados** o vac√≠os en `backend/.env`:

```env
PORT=5001
JWT_SECRET=tu_secreto_aqui

# Supabase Configuration (filled by Setup Wizard ‚Üí .env.local)
# SUPABASE_URL=
# SUPABASE_KEY=
```

```bash
cd backend && npm run dev
# Ver√°s: ‚ö†Ô∏è SUPABASE_URL / SUPABASE_KEY no configurados.
#         La app arrancar√° en modo setup (sin datos).
```

```bash
cd frontend && npm run dev
# Abre http://localhost:5173
```

### 4.2 Completar el Wizard (3 pasos)

Al abrir el frontend ver√°s el **Setup Wizard** autom√°ticamente:

#### Paso 1 ‚Äî Proveedor
- Selecciona **Supabase** (recomendado) ‚Üí click **Continuar**

#### Paso 2 ‚Äî Credenciales
1. Pega la **Supabase URL** (`https://xxxx.supabase.co`)
2. Pega la **Anon Key** (`eyJhbGciOi...`)
3. Click **Probar Conexi√≥n**
4. Si las tablas no existen (proyecto nuevo), aparecer√° el campo **Connection String**:
   - Pega el URI de **Session pooler** (ver [secci√≥n 3b](#3b-connection-string-para-crear-las-tablas))
5. Click **üöÄ Crear Tablas y Configurar**

#### Paso 3 ‚Äî Listo
- El wizard confirma que todo est√° configurado
- Click **Ir a la Tienda** ‚Üí la app carga normalmente

### 4.3 Qu√© hace el Wizard internamente

1. **Test connection**: conecta v√≠a Supabase REST API para verificar credenciales
2. **Initialize schema**: conecta v√≠a `pg` (PostgreSQL directo) al Session pooler y ejecuta:
   - `schema.sql` ‚Äî 9 tablas, √≠ndices, 2 funciones RPC, bucket de Storage + policies
   - `seed.sql` ‚Äî usuario admin, ~90 configuraciones por defecto
   - `NOTIFY pgrst, 'reload schema'` ‚Äî fuerza PostgREST a ver las nuevas tablas
3. **Configure**: escribe `backend/.env.local` con las credenciales y reinicializa el cliente Supabase en caliente (sin reiniciar el servidor)

### 4.4 Persistencia

Las credenciales se guardan en `backend/.env.local`:
```env
# Auto-generated by Setup Wizard
SUPABASE_URL=https://xxxx.supabase.co
SUPABASE_KEY=eyJhbGciOi...
JWT_SECRET=tu_secreto
```

Este archivo:
- Se carga autom√°ticamente al arrancar (`dotenv` con `override: true`)
- Sobrevive reinicios del servidor
- Tiene prioridad sobre `backend/.env`
- Est√° en `.gitignore` (no se sube al repo)

---

## 5. Configuraci√≥n Manual (alternativa)

Si prefieres no usar el wizard:

### 5.1 Ejecutar SQL en Supabase

1. Supabase Dashboard ‚Üí **SQL Editor**
2. Copia y pega el contenido de `backend/database/schema.sql` ‚Üí **Run**
3. Copia y pega el contenido de `backend/database/seed.sql` ‚Üí **Run**

### 5.2 Crear Bucket de Storage

El `schema.sql` ya incluye la creaci√≥n del bucket `products` y sus policies.
Si por alguna raz√≥n no se cre√≥, hazlo manualmente:

1. Supabase Dashboard ‚Üí **Storage** ‚Üí **New Bucket**
2. Name: `products`, Public: **ON**
3. Agrega policies:
   - **SELECT**: `bucket_id = 'products'` (para cualquier rol)
   - **INSERT**: `bucket_id = 'products'` (para cualquier rol)
   - **UPDATE**: `bucket_id = 'products'` (para cualquier rol)
   - **DELETE**: `bucket_id = 'products'` (para cualquier rol)

> Las policies son abiertas porque la autorizaci√≥n la maneja el backend con su propio middleware JWT (`requireAdmin`). Supabase Storage solo almacena archivos.

### 5.3 Configurar Variables de Entorno

Edita `backend/.env`:
```env
PORT=5001
JWT_SECRET=tu_secreto_aqui
SUPABASE_URL=https://xxxx.supabase.co
SUPABASE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

Reinicia el backend:
```bash
cd backend && npm run dev
```

---

## 6. Verificar que Todo Funciona

### 6.1 Health Check
```bash
curl http://localhost:5001/api/health
# ‚úÖ Respuesta: { "status": "ok" }
# ‚ùå Si dice { "status": "setup" } ‚Üí la DB no est√° configurada
```

### 6.2 Login con Admin por Defecto
- Abre `http://localhost:5173`
- Login: `admin@admin.com` / `admin`
- Deber√≠as ver el **Panel de Administraci√≥n**

### 6.3 Crear un Producto de Prueba
1. Admin Dashboard ‚Üí tab **Productos** ‚Üí **Agregar Producto**
2. Completa nombre, precio, stock, categor√≠a
3. Sube una imagen
4. **Guardar**
5. Si se guarda sin errores ‚Üí Storage y tablas funcionan correctamente

### 6.4 Ejecutar Tests
```bash
# Unit tests (r√°pidos, no necesitan servidor)
cd frontend && npm run test:unit

# E2E tests (necesitan backend + frontend corriendo)
cd frontend/tests && npx playwright test --config playwright.config.js --workers=1 --headed
```

---

## 7. Credenciales por Defecto

El `seed.sql` crea un usuario administrador:

| Campo | Valor |
|-------|-------|
| **Email** | `admin@admin.com` |
| **Password** | `admin` |
| **Rol** | `admin` |

> ‚ö†Ô∏è **Cambia estas credenciales inmediatamente** en producci√≥n desde el perfil de usuario o Admin Panel ‚Üí Usuarios.

Para generar un nuevo hash bcrypt:
```bash
node -e "require('bcrypt').hash('TuNuevaContrase√±a', 10).then(console.log)"
```

---

## 8. Estructura de la Base de Datos

### 9 Tablas

| Tabla | Prop√≥sito |
|-------|-----------|
| `users` | Usuarios (admin/customer), auth, direcci√≥n |
| `products` | Cat√°logo de productos |
| `product_images` | Galer√≠a de im√°genes (m√∫ltiples por producto) |
| `cart` | Carrito server-side para usuarios autenticados |
| `orders` | Pedidos (info de env√≠o, pago, tracking) |
| `order_items` | Items de cada pedido (snapshot de precio) |
| `verification_codes` | C√≥digos de verificaci√≥n email (registro, reset) |
| `app_settings` | Configuraci√≥n key-value (branding, theme, pagos, etc.) |
| `token_blacklist` | Tokens JWT revocados (logout) |

### 2 Funciones RPC

| Funci√≥n | Prop√≥sito |
|---------|-----------|
| `decrement_stock_if_available(product_id, qty)` | Decrementa stock at√≥micamente (previene overselling) |
| `increment_stock(product_id, qty)` | Incrementa stock (devoluciones/cancelaciones) |

### Storage

| Bucket | Config |
|--------|--------|
| `products` | P√∫blico (read), permisos abiertos (write/delete). Backend valida con `requireAdmin` middleware. |

### ~90 Settings por Defecto (seed)

Agrupados por secci√≥n:
- **Branding**: siteName, siteIcon, siteLogo, siteDomain
- **Hero**: t√≠tulo, descripci√≥n, tama√±os (rem), posici√≥n, imagen, overlay
- **Header**: colores de fondo, texto, botones, transparencia
- **Theme**: 5 colores (primary, secondary, accent, bg, text) ‚Üí CSS vars en `:root`
- **Product Detail Hero**: configuraci√≥n independiente del hero de Home
- **Category Filters**: JSON con categor√≠as custom
- **Product Card**: JSON con layout responsive
- **Contact**: email, tel√©fono, WhatsApp, direcci√≥n, mapa
- **Pagos**: configuraci√≥n de Stripe, PayPal, transferencia, efectivo
- **Chatbot**: proveedor LLM, API key, personalidad, UI

---

## 9. Troubleshooting

### Error: "Bucket not found"
**Causa**: El bucket `products` de Supabase Storage no existe.
**Soluci√≥n**: El `schema.sql` lo crea autom√°ticamente. Si usaste configuraci√≥n manual, crea el bucket desde Supabase Dashboard ‚Üí Storage ‚Üí New Bucket ‚Üí `products` (Public: ON).

### Error: "new row violates row-level security policy"
**Causa**: Las policies de Storage usan `auth.role() = 'authenticated'` pero la app usa JWT propio (no Supabase Auth).
**Soluci√≥n**: Las policies deben permitir acceso sin restricci√≥n de rol de Supabase. El `schema.sql` actual ya incluye las policies correctas. Si persiste, borra las policies existentes y re-ejecuta el schema.

### Error: "No se pudo resolver el host" / ENOTFOUND
**Causa**: Usaste `db.<ref>.supabase.co` (Direct connection) que solo funciona en IPv6.
**Soluci√≥n**: Usa **Session pooler** desde Supabase Dashboard ‚Üí Connect ‚Üí Method: **Session pooler**. El host correcto es `aws-0-<region>.pooler.supabase.com:5432`.

### Error: "Puerto 6543 es Transaction mode"
**Causa**: Copiaste el Connection String de Transaction mode.
**Soluci√≥n**: Cambia a **Session pooler** (puerto 5432). Transaction mode (6543) no soporta DDL.

### Error: "Tenant or user not found"
**Causa**: Contrase√±a incorrecta o project ref no v√°lido.
**Soluci√≥n**: Resetea tu contrase√±a en Supabase Dashboard ‚Üí Settings ‚Üí Database ‚Üí Reset database password. Copia el nuevo Connection String.

### Error: "password authentication failed"
**Causa**: La contrase√±a en el Connection String es incorrecta.
**Soluci√≥n**: Verifica que usaste la contrase√±a de la **base de datos** (la que elegiste al crear el proyecto), NO la API Key ni el JWT Secret.

### El backend arranca pero el frontend muestra el Setup Wizard
**Causa**: `SUPABASE_URL` o `SUPABASE_KEY` no est√°n configurados o tienen valores placeholder.
**Soluci√≥n**: 
1. Verifica `backend/.env` y `backend/.env.local`
2. Aseg√∫rate de que no hay valores como `SUPABASE_URL=https://supabase.co` (URL gen√©rica sin project ref)
3. Si completaste el wizard, verifica que `backend/.env.local` existe y tiene las credenciales

### El hero/texto aparece extremadamente grande despu√©s del seed
**Causa**: Versiones anteriores del seed usaban p√≠xeles (36, 18) pero el frontend usa rem (2.1, 1.05).
**Soluci√≥n**: El seed actual ya tiene los valores correctos en rem. Si tu DB tiene valores antiguos, actualiza desde Admin Panel ‚Üí Configuraci√≥n ‚Üí Hero ‚Üí ajusta los tama√±os de texto.

### ¬øC√≥mo desconectar/resetear la base de datos?
1. Admin Panel ‚Üí Configuraci√≥n ‚Üí **Zona de Riesgo** ‚Üí **Desconectar Base de Datos**
2. Esto limpia las credenciales y vuelve al modo setup
3. El wizard aparecer√° al recargar la p√°gina

---

## Resumen del Flujo Completo

```
1. Crear proyecto en Supabase
         ‚Üì
2. Copiar URL + Anon Key + Connection String (Session pooler)
         ‚Üì
3. Arrancar backend (sin SUPABASE_URL ‚Üí modo setup)
         ‚Üì
4. Abrir frontend ‚Üí Setup Wizard aparece autom√°ticamente
         ‚Üì
5. Paso 1: Seleccionar Supabase
         ‚Üì
6. Paso 2: Pegar URL + Key ‚Üí Probar Conexi√≥n
         ‚Üì
7. Si tablas no existen ‚Üí Pegar Connection String ‚Üí "Crear Tablas y Configurar"
         ‚Üì
8. Autom√°ticamente: schema.sql + seed.sql + bucket + policies + .env.local
         ‚Üì
9. Paso 3: ¬°Listo! ‚Üí Ir a la Tienda
         ‚Üì
10. Login: admin@admin.com / admin ‚Üí Cambiar credenciales
```
