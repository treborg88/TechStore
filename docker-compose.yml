# =============================================================================
# TechStore — Docker Compose
# =============================================================================
# Runs the full stack: backend (Express) + frontend (Nginx serving Vite build)
# behind an Nginx reverse proxy that unifies everything on port 80/443.
#
# Usage:
#   docker compose up --build          # Build and start
#   docker compose up -d               # Start in background
#   docker compose down                # Stop and remove
#   docker compose logs -f backend     # Follow backend logs
#
# Environment:
#   Copy backend/.env.example to backend/.env and fill in credentials.
#   The backend container reads it automatically via env_file.
# =============================================================================

services:
  # ─────────────────────────────────────────────
  # Backend: Express API on port 5001
  # ─────────────────────────────────────────────
  backend:
    build:
      context: .
      dockerfile: docker/Dockerfile.backend
    container_name: techstore-backend
    restart: unless-stopped
    env_file:
      - ./backend/.env
    ports:
      - "5001:5001"
    volumes:
      # Persist logs outside the container
      - ./logs:/app/backend/logs
    networks:
      - techstore

  # ─────────────────────────────────────────────
  # Frontend: Vite build served by Nginx on port 3000
  # ─────────────────────────────────────────────
  frontend:
    build:
      context: .
      dockerfile: docker/Dockerfile.frontend
      args:
        # /api is relative — the proxy container handles routing
        VITE_API_URL: /api
    container_name: techstore-frontend
    restart: unless-stopped
    networks:
      - techstore

  # ─────────────────────────────────────────────
  # Proxy: Nginx reverse proxy (entry point)
  # ─────────────────────────────────────────────
  # Unifies frontend + backend on a single port.
  # - /api/*  → backend:5001
  # - /p/*    → backend:5001  (social sharing OG meta)
  # - /*      → frontend:80   (SPA)
  proxy:
    image: nginx:alpine
    container_name: techstore-proxy
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./docker/nginx-proxy.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - backend
      - frontend
    networks:
      - techstore

networks:
  techstore:
    driver: bridge
