#!/bin/bash
# =============================================================================
# TechStore â€” Docker deploy on fresh Ubuntu 22.04 ARM64
# =============================================================================
# Run this on the VM after SSH-ing in:
#   curl -fsSL https://raw.githubusercontent.com/treborg88/TechStore/main/scripts/docker-deploy.sh | bash
#
# Or manually:
#   ssh -i ~/.ssh/oci_test ubuntu@<VM_IP>
#   bash scripts/docker-deploy.sh
#
# What it does:
#   1. Install Docker Engine + Compose plugin
#   2. Clone the repo
#   3. Generate a random JWT_SECRET
#   4. Start the full stack (PostgreSQL + backend + frontend + nginx)
#   5. Print access URLs
# =============================================================================

set -euo pipefail

APP_DIR="$HOME/TechStore"
REPO_URL="https://github.com/treborg88/TechStore.git"
BRANCH="main"

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘   TechStore â€” Docker Full Stack Deploy (ARM64)       â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# â”€â”€ 1. Install Docker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ğŸ“¦ Installing Docker Engine..."
if ! command -v docker &>/dev/null; then
  # Official Docker install script (supports ARM64)
  curl -fsSL https://get.docker.com | sudo sh
  # Add current user to docker group (avoids sudo)
  sudo usermod -aG docker "$USER"
  echo "âœ… Docker installed: $(docker --version)"
else
  echo "âœ… Docker already installed: $(docker --version)"
fi

# Ensure docker compose plugin is available
if ! docker compose version &>/dev/null; then
  echo "ğŸ“¦ Installing Docker Compose plugin..."
  sudo apt-get update -y
  sudo apt-get install -y docker-compose-plugin
fi
echo "âœ… Docker Compose: $(docker compose version)"

# â”€â”€ 2. Clone repository â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo ""
echo "ğŸ“‚ Cloning repository..."
if [ -d "$APP_DIR" ]; then
  echo "   Directory exists, pulling latest..."
  cd "$APP_DIR"
  git pull origin "$BRANCH"
else
  git clone --branch "$BRANCH" "$REPO_URL" "$APP_DIR"
  cd "$APP_DIR"
fi

# â”€â”€ 3. Create .env file â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo ""
echo "ğŸ” Generating environment config..."

# Generate random JWT_SECRET (64 chars)
JWT_SECRET=$(openssl rand -hex 32)

# Create backend .env with Docker defaults
cat > backend/.env <<EOF
# Auto-generated by docker-deploy.sh â€” $(date -Iseconds)
JWT_SECRET=${JWT_SECRET}
PORT=5001
NODE_ENV=production

# Database: Docker PostgreSQL (configured by docker-compose.yml)
DB_PROVIDER=postgres
DATABASE_URL=postgresql://techstore:techstore@database:5432/techstore
EOF

echo "âœ… backend/.env created (JWT_SECRET generated)"

# â”€â”€ 4. Build & start containers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo ""
echo "ğŸ³ Building and starting containers..."
echo "   (This may take 3-5 minutes on first run)"
echo ""

# Use newgrp to get docker group in current session, or sudo
if groups | grep -q docker; then
  docker compose up --build -d
else
  sudo docker compose up --build -d
fi

# â”€â”€ 5. Wait for health checks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo ""
echo "â³ Waiting for services to start..."
sleep 10

# Check container status
echo ""
echo "ğŸ“Š Container status:"
if groups | grep -q docker; then
  docker compose ps
else
  sudo docker compose ps
fi

# â”€â”€ 6. Print access info â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PUBLIC_IP=$(curl -s ifconfig.me 2>/dev/null || echo "UNKNOWN")

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘   ğŸ‰ Deploy complete!                                â•‘"
echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
echo "â•‘                                                      â•‘"
echo "â•‘   App:      http://${PUBLIC_IP}                      â•‘"
echo "â•‘   API:      http://${PUBLIC_IP}/api/products         â•‘"
echo "â•‘   Setup:    http://${PUBLIC_IP}  (first visit)       â•‘"
echo "â•‘                                                      â•‘"
echo "â•‘   PostgreSQL is inside Docker â€” no external access   â•‘"
echo "â•‘   JWT_SECRET: auto-generated (see backend/.env)      â•‘"
echo "â•‘                                                      â•‘"
echo "â•‘   Useful commands:                                   â•‘"
echo "â•‘     docker compose logs -f backend                   â•‘"
echo "â•‘     docker compose restart backend                   â•‘"
echo "â•‘     docker compose down                              â•‘"
echo "â•‘     docker compose up --build -d                     â•‘"
echo "â•‘                                                      â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
