# Rollback Manual
# Ejecutar manualmente si un deploy falla y necesitas revertir

name: ðŸ”™ Rollback

on:
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'Commit SHA al que revertir (dejar vacÃ­o para el anterior)'
        required: false
        default: ''
      reason:
        description: 'RazÃ³n del rollback'
        required: true

env:
  SERVER_IP: 143.47.118.165
  SERVER_USER: ${{ secrets.SERVER_USER }}
  APP_PATH: ${{ secrets.APP_PATH }}

jobs:
  rollback:
    name: ðŸ”™ Rollback
    runs-on: ubuntu-latest
    
    steps:
      - name: Configurar SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Ejecutar rollback
        run: |
          ssh -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_IP }} << 'ENDSSH'
            set -e
            cd ${{ env.APP_PATH }}
            
            echo "ðŸ“‹ RazÃ³n del rollback: ${{ github.event.inputs.reason }}"
            
            COMMIT="${{ github.event.inputs.commit_sha }}"
            if [ -z "$COMMIT" ]; then
              echo "ðŸ”™ Revirtiendo al commit anterior..."
              git reset --hard HEAD~1
            else
              echo "ðŸ”™ Revirtiendo al commit: $COMMIT"
              git reset --hard $COMMIT
            fi
            
            echo "ðŸ“¦ Reinstalando dependencias..."
            npm ci --ignore-scripts
            cd backend && npm ci --production && cd ..
            cd frontend && npm ci
            export VITE_API_URL="${{ secrets.VITE_API_URL }}"
            export VITE_BASE_URL="${{ secrets.VITE_BASE_URL }}"
            npm run build && cd ..
            
            echo "ðŸ”„ Reiniciando servicios..."
            pm2 reload all --update-env
            
            echo "âœ… Rollback completado!"
            git log -1 --oneline
          ENDSSH

      - name: Log rollback
        run: |
          echo "âš ï¸ ROLLBACK ejecutado"
          echo "RazÃ³n: ${{ github.event.inputs.reason }}"
          echo "Por: ${{ github.actor }}"
          echo "Fecha: $(date)"
