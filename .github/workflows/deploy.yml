# CD - Despliegue Continuo con Ansible
# Producci√≥n objetivo: SOLO host prod-1

name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:  # Permite ejecutar manualmente desde GitHub
    inputs:
      deploy_tags:
        description: 'Tags de Ansible a ejecutar'
        required: false
        default: 'deploy,verify'

env:
  ANSIBLE_HOST_KEY_CHECKING: "False"
  DEPLOY_LIMIT: prod-1
  DEPLOY_TAGS: ${{ github.event.inputs.deploy_tags || 'deploy,verify' }}

jobs:
  deploy:
    name: üöÄ Deploy (Ansible)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar Ansible y colecci√≥n community.general
        run: |
          python -m pip install --upgrade pip
          pip install ansible
          ansible-galaxy collection install community.general

      - name: Configurar SSH para Ansible
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/oracle_key
          chmod 600 ~/.ssh/oracle_key
          HOSTS=$(ansible-inventory -i ansible/inventory.yml --list | python -c "import sys,json; d=json.load(sys.stdin); hv=d.get('_meta',{}).get('hostvars',{}); print(' '.join(sorted({v.get('ansible_host',k) for k,v in hv.items()})))")
          for host in $HOSTS; do
            ssh-keyscan -H "$host" >> ~/.ssh/known_hosts
          done

      - name: Validar inventario y sintaxis
        run: |
          ansible-inventory -i ansible/inventory.yml --list
          ansible-playbook -i ansible/inventory.yml ansible/playbook.yml --syntax-check

      - name: Deploy con Ansible
        run: |
          ansible-playbook \
            -i ansible/inventory.yml \
            ansible/playbook.yml \
            --limit "${{ env.DEPLOY_LIMIT }}" \
            --tags "${{ env.DEPLOY_TAGS }}"

      - name: Notificar resultado
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deploy exitoso con Ansible en prod-1"
          else
            echo "‚ùå Deploy fall√≥ - revisar logs de Ansible"
          fi
