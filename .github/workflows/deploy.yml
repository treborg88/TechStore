# CD - Despliegue Continuo
# Se ejecuta automÃ¡ticamente al hacer push a main

name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:  # Permite ejecutar manualmente desde GitHub

env:
  SERVER_IP: 143.47.118.165
  SERVER_USER: ${{ secrets.SERVER_USER }}
  APP_PATH: ${{ secrets.APP_PATH }}

jobs:
  deploy:
    name: ðŸš€ Deploy
    runs-on: ubuntu-latest
    # Solo ejecutar si CI pasÃ³ (en el mismo push)
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Deploy al servidor
        run: |
          ssh -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_IP }} << 'ENDSSH'
            set -e
            
            echo "ðŸ“‚ Navegando al directorio de la app..."
            cd ${{ env.APP_PATH }}
            
            echo "ðŸ“¥ Actualizando cÃ³digo desde GitHub..."
            git fetch origin main
            git reset --hard origin/main
            
            echo "ðŸ“¦ Instalando dependencias del root..."
            npm ci --ignore-scripts
            
            echo "ðŸ“¦ Instalando dependencias del backend..."
            cd backend
            npm ci --production
            cd ..
            
            echo "ðŸ“¦ Instalando dependencias del frontend..."
            cd frontend
            npm ci
            
            echo "ðŸ—ï¸ Building frontend..."
            # config.js uses smart defaults: /api (relative) + window.location.origin
            # No VITE_ env vars needed â€” works on any domain behind Nginx
            npm run build
            cd ..
            
            echo "ðŸ”„ Reiniciando servicios con PM2..."
            pm2 reload all --update-env
            
            echo "âœ… Deploy completado exitosamente!"
            pm2 status
          ENDSSH

      - name: Verificar deploy
        run: |
          echo "ðŸ” Verificando que el servidor responde..."
          sleep 5
          curl -f -s -o /dev/null -w "%{http_code}" http://${{ env.SERVER_IP }}:5173 || echo "âš ï¸ Frontend no responde aÃºn"
          curl -f -s -o /dev/null -w "%{http_code}" http://${{ env.SERVER_IP }}:5001/api/products || echo "âš ï¸ API no responde aÃºn"

      - name: Notificar resultado
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deploy exitoso a http://${{ env.SERVER_IP }}:5173"
          else
            echo "âŒ Deploy fallÃ³ - revisar logs"
          fi
