# CD - Despliegue Continuo con Ansible
# Soporta prod-1 (Oracle) y prod-2 (GCP)

name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'Servidor destino'
        required: true
        default: 'prod-1'
        type: choice
        options:
          - prod-1
          - prod-2
          - all
      deploy_tags:
        description: 'Tags de Ansible a ejecutar'
        required: false
        default: 'deploy,verify'

env:
  ANSIBLE_HOST_KEY_CHECKING: "False"
  # push a main ‚Üí prod-1 solamente; manual ‚Üí selecci√≥n del usuario
  DEPLOY_LIMIT: ${{ github.event.inputs.deploy_target || 'prod-1' }}
  DEPLOY_TAGS: ${{ github.event.inputs.deploy_tags || 'deploy,verify' }}

jobs:
  deploy:
    name: üöÄ Deploy (Ansible)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar Ansible y colecci√≥n community.general
        run: |
          python -m pip install --upgrade pip
          pip install ansible
          ansible-galaxy collection install community.general

      - name: Configurar SSH para Ansible
        run: |
          mkdir -p ~/.ssh

          # prod-1 (Oracle) SSH key
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/oracle_key
          chmod 600 ~/.ssh/oracle_key

          # prod-2 (GCP) SSH key
          echo "${{ secrets.GCP_SSH_PRIVATE_KEY }}" > ~/.ssh/gcp_prod2
          chmod 600 ~/.ssh/gcp_prod2

          # Escanear hosts conocidos
          HOSTS=$(ansible-inventory -i ansible/inventory.yml --list | python -c "import sys,json; d=json.load(sys.stdin); hv=d.get('_meta',{}).get('hostvars',{}); print(' '.join(sorted({v.get('ansible_host',k) for k,v in hv.items()})))")
          for host in $HOSTS; do
            ssh-keyscan -H "$host" >> ~/.ssh/known_hosts
          done

      - name: Validar inventario y sintaxis
        run: |
          ansible-inventory -i ansible/inventory.yml --list
          ansible-playbook -i ansible/inventory.yml ansible/playbook.yml --syntax-check

      - name: Deploy con Ansible
        env:
          CF_ORIGIN_CERT: ${{ secrets.CF_ORIGIN_CERT }}
          CF_ORIGIN_KEY: ${{ secrets.CF_ORIGIN_KEY }}
        run: |
          # Escribir cert/key a archivos temporales (evita problemas con multiline en CLI)
          CERT_FILE=$(mktemp)
          KEY_FILE=$(mktemp)
          echo "$CF_ORIGIN_CERT" > "$CERT_FILE"
          echo "$CF_ORIGIN_KEY" > "$KEY_FILE"

          # Si target es "all", no aplicar --limit (deploy a todos)
          LIMIT_ARG=""
          if [ "${{ env.DEPLOY_LIMIT }}" != "all" ]; then
            LIMIT_ARG="--limit ${{ env.DEPLOY_LIMIT }}"
          fi

          ansible-playbook \
            -i ansible/inventory.yml \
            ansible/playbook.yml \
            $LIMIT_ARG \
            --tags "${{ env.DEPLOY_TAGS }}" \
            -e "cf_origin_cert_file=$CERT_FILE" \
            -e "cf_origin_key_file=$KEY_FILE"

          # Limpiar archivos temporales
          rm -f "$CERT_FILE" "$KEY_FILE"

      - name: Notificar resultado
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deploy exitoso ‚Äî target: ${{ env.DEPLOY_LIMIT }}"
          else
            echo "‚ùå Deploy fall√≥ ‚Äî target: ${{ env.DEPLOY_LIMIT }}"
          fi
